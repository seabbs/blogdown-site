---
title: getTBinR 0.5.7 now on CRAN - Tuberculosis reports and summary plots
author: 'null'
date: '2019-01-22'
slug: gettbinr-5-7
twitterImg: img/getTBinR/release-5-7.png
description: "getTBinR version 0.5.7 now with a new plotting function to quickly show regional and global metrics + a new country level Tuberculosis report generating function. Tweet an instance of you using the package at me and potentially recieve a hexsticker!"
categories: ["R"]
tags: ["data analysis", "data visualisation", "rstats", "TB", "WHO", "getTBinR", "infectious disease"]
---



<p><a href="https://www.samabbott.co.uk/getTBinR/"><code>getTBinR 0.5.7</code></a> is now on CRAN and should be available on a mirror near you shortly! This update mainly focussed on building out new country level Tuberculosis (TB) report functionality but along the way this led to a new summary plotting function that quickly and easily shows TB trends across regions and globally. I also had some fun developing a hexsticker (Tweet at me with something you made using the package to get a physical version - whilst my postage money lastsâ€¦), reducing the dependencies with <a href="https://github.com/jimhester/itdepends"><code>itdepends</code></a> and <a href="https://uptakeopensource.github.io/pkgnet/index.html"><code>pkgnet</code></a> and dealing with some breaking changes from an uncoming <code>dplyr</code> update (my own fault for missing a function import).</p>
<p>The full changelog is below along with an example of the country level TB report generated for the UK (generate a report on the country of your choice using <code>getTBinR::render_country_report(country = &quot;United Kingdom&quot;, save_dir = &quot;.&quot;)</code>).</p>
<div id="feature-updates" class="section level2">
<h2>Feature updates</h2>
<ul>
<li>Added support for annual_change to summarise_tb_burden and added validating tests.</li>
<li>Added support for rates and proportions to summarise_tb_burden and added validating tests.</li>
<li>Added a new function - plot_tb_burden_summary. Function wraps summarise_tb_burden and allows all in one summary plotting. Inspired by this case study.</li>
<li>Added a rmarkdown parameterised country level report on TB.</li>
<li>Added a report generating button to the dashboard generated by run_tb_dashboard.</li>
<li>Added render_country_report to generate a TB report for a given country.</li>
<li>Tweaked map_tb_burden to not use geom_path for country outlines.</li>
<li>Added a smooth argument to plot_tb_burden to allow smooth trend lines to be plotted (derived using ggplot2::geom_smooth).</li>
<li>Tweaked line thickness in plot_tb_burden to improve plot appearance.</li>
<li>Added legend argument to all plotting functions to allow control of the legend appearance.</li>
</ul>
</div>
<div id="package-updates" class="section level2">
<h2>Package updates</h2>
<ul>
<li>Added script to generate hexsticker</li>
<li>Added hexsticker to README</li>
<li>Added DOI link to Zenodo.</li>
<li>Updated tests to account for dplyr 8.0 release and vdiffr updates.</li>
<li>Added itdepends to package report functionality.</li>
</ul>
</div>
<div id="example-united-kingdom-tuberculosis-report" class="section level2">
<h2>Example: United Kingdom Tuberculosis Report</h2>
<pre class="r"><code>## Load the package
library(getTBinR)
## Load additional packages
library(dplyr) # For data munging 
library(tidyr)
library(rlang)
library(ggplot2)

## Get the data
tb &lt;- get_tb_burden(verbose = FALSE)
## Get the data dictionary
dict &lt;- get_data_dict(verbose = FALSE)
##Assign parameters - these are set in the YAML within the package
country &lt;- &quot;United Kingdom&quot;
interactive &lt;- FALSE</code></pre>
</div>
<div id="tb-incidence-rates" class="section level2">
<h2>TB incidence rates</h2>
<pre class="r"><code>metric_summary &lt;- function(df = NULL, target_country = NULL, metric = NULL) {
  
  target_country &lt;- df$country[grepl(target_country, df$country)] %&gt;% 
    unique %&gt;% 
    first
    
  ##  Set up metric with confidence intervals
  metric &lt;- enquo(metric)
  metric_lo &lt;- sym(paste0(quo_name(metric), &quot;_lo&quot;))
  metric_hi &lt;- sym(paste0(quo_name(metric), &quot;_hi&quot;))
  
  ## Filter for the country of interest
  country_df &lt;- df %&gt;% 
  filter(country %in% target_country)
  
## Most up to date year of incidence data
recent_inc &lt;- country_df %&gt;% 
  drop_na(!!metric) %&gt;% 
  filter(year == max(year)) %&gt;% 
  select(!!metric, !!metric_lo, !!metric_hi, year, g_whoregion) %&gt;% 
  mutate(inc_rate = paste0(!!metric, &quot; (&quot;, !!metric_lo, &quot; - &quot;, !!metric_hi, &quot;)&quot;))
## Country rank
ranked_countries_inc &lt;- df %&gt;% 
  filter(year == recent_inc$year) %&gt;% 
  arrange(desc(!!metric)) %&gt;% 
  mutate(rank = 1:n())
## World rank
target_rank_world &lt;- ranked_countries_inc %&gt;% 
  filter(country == target_country) %&gt;% 
  pull(rank)
## Region rank
target_rank_region &lt;- ranked_countries_inc %&gt;% 
  filter(g_whoregion %in% recent_inc$g_whoregion) %&gt;% 
  mutate(rank = 1:n()) %&gt;% 
  filter(country == target_country) %&gt;%
  pull(rank)
## Summarise annual change
country_change &lt;- summarise_tb_burden(metric = quo_name(metric),
                                      stat = &quot;mean&quot;,
                                      countries = target_country,
                                      compare_to_region = FALSE,
                                      compare_to_world = FALSE,
                                      compare_all_regions = FALSE,
                                      annual_change = TRUE,
                                      verbose = FALSE) %&gt;% 
  filter(year &gt; (max(year) - 10)) %&gt;% 
  summarise(change = mean(!!metric, na.rm = FALSE)) %&gt;%
  mutate(change = round(change * 100, 1) %&gt;% 
           paste0(., &quot;%&quot;)) %&gt;% 
  pull(change)
out &lt;- list(recent_inc$year[1], recent_inc$inc_rate[1],
            target_rank_world, target_rank_region,
            country_change)
names(out) &lt;- c(&quot;year&quot;, &quot;metric&quot;, &quot;world_rank&quot;, &quot;region_rank&quot;, &quot;avg_change&quot;)
out &lt;- ifelse(is.na(out), &quot;(Missing)&quot;, out)
return(out)
}
  
  
inc_sum &lt;- metric_summary(tb, country, e_inc_100k)</code></pre>
<p>In 2017 United Kingdom had an estimated Tuberculosis incidence rate of 8.9 (8.1 - 9.8) per 100,000 people making it number 165 in the world and number 32 regionally. In the last 10 years this has changed by -4.9% on average each year.</p>
<div id="regional-and-global-trends-comparision" class="section level3">
<h3>Regional and Global Trends Comparision</h3>
<pre class="r"><code>plot_tb_burden_summary(countries = country,
                       metric_label = &quot;e_inc_100k&quot;,
                       compare_to_world = TRUE, 
                       compare_to_region = TRUE,
                       compare_all_regions = FALSE,
                       annual_change = FALSE,
                       facet = &quot;Area&quot;,
                       scales = &quot;free_y&quot;,
                       legend = &quot;none&quot;,
                       interactive = interactive,
                       verbose = FALSE)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
</div>
<div id="rates-regional-breakdown" class="section level2">
<h2>Rates Regional Breakdown</h2>
<pre class="r"><code>plot_tb_burden_overview(countries = country,
                        compare_to_region = TRUE,
                        interactive = interactive,
                        verbose = FALSE)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-2-1.png" width="768" /></p>
</div>
<div id="case-detection-rates-cdr" class="section level2">
<h2>Case Detection Rates (CDR)</h2>
<p>United Kingdom had an estimated case detection rate of 89 (81 - 98)% in 2017 making it number 4 in the world (with number 1 having the highest CDR) and number 3 regionally. In the last 10 years this has changed by 0% on average each year.</p>
<div id="regional-breakdown" class="section level3">
<h3>Regional Breakdown</h3>
<pre class="r"><code>plot_tb_burden_overview(metric = &quot;c_cdr&quot;,
                        countries = country,
                        compare_to_region = TRUE,
                        interactrive = interactive,
                        verbose = FALSE)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-4-1.png" width="768" /></p>
</div>
</div>
<div id="tb-mortality-rates---excluding-hiv" class="section level2">
<h2>TB mortality rates - excluding HIV</h2>
<p>In 2017 United Kingdom had an estimated Tuberculosis mortality rate (excluding HIV) of 0.53 (0.52 - 0.53) per 100,000 people making it number 166 in the world and number 32 regionally. In the last 10 years this has changed by -1.6% on average each year.</p>
<div id="proportion-of-tb-cases-that-died-excluding-hiv---regional-and-global-comparision" class="section level3">
<h3>Proportion of TB Cases that Died (excluding HIV) - Regional and Global Comparision</h3>
<pre class="r"><code>plot_tb_burden_summary(metric = &quot;e_mort_exc_tbhiv_num&quot;,
                       denom = &quot;e_inc_num&quot;,
                       rate_scale = 100,
                       countries = country,
                       compare_to_region = TRUE,
                       compare_all_regions = FALSE,
                       interactive = interactive,
                       verbose = FALSE,
                       facet = &quot;Area&quot;,
                       scales = &quot;free_y&quot;,
                       legend = &quot;none&quot;) +
  labs(y = &quot;Proportion (%) of TB cases that died (excluding HIV)&quot;)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-6-1.png" width="1152" /></p>
</div>
<div id="rates-regional-breakdown-1" class="section level3">
<h3>Rates Regional Breakdown</h3>
<pre class="r"><code>plot_tb_burden_overview(metric = &quot;e_mort_exc_tbhiv_100k&quot;,
                        countries = country,
                        compare_to_region = TRUE,
                        interactrive = interactive,
                        verbose = FALSE)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
</div>
</div>
<div id="tb-hiv-related-mortality-rates" class="section level2">
<h2>TB HIV related mortality rates</h2>
<p>In 2017 United Kingdom had an estimated Tuberculosis mortality rate (related to HIV) of 0.1 (0.05 - 0.16) per 100,000 people making it number 127 in the world and number 23 regionally. In the last 10 years this has changed by 7.6% on average each year.</p>
<div id="proportion-of-tb-cases-that-died-related-to-hiv---regional-and-global-comparision" class="section level3">
<h3>Proportion of TB Cases that Died (related to HIV) - Regional and Global Comparision</h3>
<pre class="r"><code>plot_tb_burden_summary(metric = &quot;e_mort_tbhiv_num&quot;,
                       denom = &quot;e_inc_num&quot;,
                       rate_scale = 100,
                       countries = country,
                       compare_to_region = TRUE,
                       compare_all_regions = FALSE,
                       interactive = interactive,
                       verbose = FALSE,
                       facet = &quot;Area&quot;,
                       scales = &quot;free_y&quot;,
                       legend = &quot;none&quot;) +
  labs(y = &quot;Proportion (%) of TB cases that died (related to HIV)&quot;)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-9-1.png" width="1152" /></p>
</div>
<div id="rates-regional-breakdown-2" class="section level3">
<h3>Rates Regional Breakdown</h3>
<pre class="r"><code>plot_tb_burden_overview(metric = &quot;e_mort_tbhiv_100k&quot;,
                        countries = country,
                        compare_to_region = TRUE,
                        interactrive = interactive,
                        verbose = FALSE)</code></pre>
<p><img src="/post/2019-01-22-gettbinr-5-7_files/figure-html/unnamed-chunk-10-1.png" width="768" /></p>
<p>For other examples of using <code>getTBinR</code> to visualise the WHO TB data see <a href="https://gist.github.com/seabbs">my</a> gists, previous blog <a href="https://www.samabbott.co.uk/tags/who/">posts</a>, and the <a href="https://www.samabbott.co.uk/getTBinR/"><code>getTBinR</code> website</a>.</p>
</div>
</div>
